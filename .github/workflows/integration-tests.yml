name: Integration Tests (External APIs)

# This workflow runs tests that require external API keys (LLM, AI Defense, VirusTotal).
# Manually triggered only to prevent resource exhaustion and protect API keys.

on:
  workflow_dispatch:
    inputs:
      test_llm:
        description: 'Run LLM analyzer tests'
        required: false
        type: boolean
        default: true
      test_aidefense:
        description: 'Run AI Defense analyzer tests'
        required: false
        type: boolean
        default: true
      test_virustotal:
        description: 'Run VirusTotal analyzer tests'
        required: false
        type: boolean
        default: true

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python for uv
        uses: astral-sh/setup-uv@v6.7.0

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run LLM analyzer tests
        if: inputs.test_llm
        env:
          SKILL_SCANNER_LLM_API_KEY: ${{ secrets.SKILL_SCANNER_LLM_API_KEY || secrets.GEMINI_API_KEY }}
          SKILL_SCANNER_LLM_MODEL: ${{ secrets.SKILL_SCANNER_LLM_MODEL }}
          SKILL_SCANNER_LLM_BASE_URL: ${{ secrets.SKILL_SCANNER_LLM_BASE_URL }}
          SKILL_SCANNER_LLM_API_VERSION: ${{ secrets.SKILL_SCANNER_LLM_API_VERSION }}
        run: |
          if [ -n "$SKILL_SCANNER_LLM_API_KEY" ]; then
            echo "Running LLM analyzer tests..."
            uv run pytest tests/test_llm_analyzer.py -v --tb=short
          else
            echo "Skipping LLM tests - no API keys configured"
          fi

      - name: Run AI Defense analyzer tests
        if: inputs.test_aidefense
        env:
          AI_DEFENSE_API_KEY: ${{ secrets.AI_DEFENSE_API_KEY }}
        run: |
          if [ -n "$AI_DEFENSE_API_KEY" ]; then
            echo "Running AI Defense analyzer tests..."
            uv run pytest tests/test_aidefense_analyzer.py -v --tb=short -k "not mock"
          else
            echo "Skipping AI Defense tests - no API key configured"
          fi

      - name: Run VirusTotal analyzer tests
        if: inputs.test_virustotal
        env:
          VIRUSTOTAL_API_KEY: ${{ secrets.VIRUSTOTAL_API_KEY }}
        run: |
          if [ -n "$VIRUSTOTAL_API_KEY" ]; then
            echo "Running VirusTotal analyzer tests..."
            uv run pytest tests/test_virustotal_analyzer.py tests/test_virustotal_upload.py tests/test_virustotal_benign.py -v --tb=short -k "not mock"
          else
            echo "Skipping VirusTotal tests - no API key configured"
          fi

      - name: Run full evaluation with LLM
        if: inputs.test_llm
        env:
          SKILL_SCANNER_LLM_API_KEY: ${{ secrets.SKILL_SCANNER_LLM_API_KEY || secrets.GEMINI_API_KEY }}
          SKILL_SCANNER_LLM_MODEL: ${{ secrets.SKILL_SCANNER_LLM_MODEL }}
          SKILL_SCANNER_LLM_BASE_URL: ${{ secrets.SKILL_SCANNER_LLM_BASE_URL }}
          SKILL_SCANNER_LLM_API_VERSION: ${{ secrets.SKILL_SCANNER_LLM_API_VERSION }}
        run: |
          if [ -n "$SKILL_SCANNER_LLM_API_KEY" ]; then
            echo "Running evaluation with LLM analyzer..."
            uv run python evals/runners/eval_runner.py --test-skills-dir evals/skills --use-llm
          else
            echo "Skipping LLM evaluation - no API key configured"
          fi
