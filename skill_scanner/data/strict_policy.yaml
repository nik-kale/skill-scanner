# Skill Scanner – STRICT Scan Policy
# ====================================
# Maximum security posture.  Narrow allowlists, fewer suppressions.
# Use for: untrusted / external skills, security audits, compliance.
#
# Usage:
#   skill-scanner scan --policy strict ./my-skill

policy_name: strict
policy_version: "1.0"
preset_base: strict

# ---------------------------------------------------------------------------
# Hidden files – only the absolute essentials are benign
# ---------------------------------------------------------------------------
hidden_files:
  benign_dotfiles:
    - ".gitignore"
    - ".gitattributes"
    - ".gitmodules"
    - ".gitkeep"
    - ".editorconfig"
    - ".dockerignore"

  benign_dotdirs:
    - ".github"
    - ".circleci"
    - ".gitlab"

# ---------------------------------------------------------------------------
# Pipeline taint – no trusted installers, no benign pipes
# ---------------------------------------------------------------------------
# In strict mode every curl|sh is flagged at full severity
pipeline:
  known_installer_domains: []

  benign_pipe_targets:
    # Only the most obviously safe patterns
    - 'ps\s.*\|\s*grep'
    - 'grep\s.*\|\s*grep\s+-v'

  doc_path_indicators:
    - "references"
    - "docs"

  demote_in_docs: false
  demote_instructional: false
  check_known_installers: false
  dedupe_equivalent_pipelines: false
  compound_fetch_require_download_intent: false
  compound_fetch_filter_api_requests: false
  compound_fetch_filter_shell_wrapped_fetch: false
  compound_fetch_exec_prefixes:
    - "sudo"
    - "env"
    - "command"
    - "time"
    - "nohup"
    - "nice"
  compound_fetch_exec_commands:
    - "bash"
    - "sh"
    - "zsh"
    - "source"
    - "python"
    - "python3"
    - "perl"
    - "ruby"
    - "node"
    - "."
  # Hint words for data exfiltration detection in tool-chaining
  exfil_hints:
    - "send"
    - "upload"
    - "transmit"
    - "webhook"
    - "slack"
    - "exfil"
    - "forward"
  # Tokens that indicate API/framework docs (suppress tool-chaining FP)
  api_doc_tokens:
    - "@app."
    - "app."
    - "router."
    - "route"
    - "endpoint"

# ---------------------------------------------------------------------------
# Rule scoping – fire rules more broadly
# ---------------------------------------------------------------------------
rule_scoping:
  # In strict mode, coercive/autonomy rules fire on ALL text files
  skillmd_and_scripts_only: []

  # Only skip YARA in explicit documentation directories
  skip_in_docs:
    - "code_execution_generic"
    - "system_manipulation_generic"
    - "script_injection_generic"
    # JS/TS rules – skip in documentation context even in strict mode
    - "COMMAND_INJECTION_JS_CHILD_PROCESS"
    - "COMMAND_INJECTION_JS_FUNCTION_CONSTRUCTOR"
    - "DATA_EXFIL_JS_NETWORK"
    - "DATA_EXFIL_JS_FS_ACCESS"

  # Unicode steganography fires on everything (strict wants max coverage)
  code_only:
    - "sql_injection_generic"

  doc_path_indicators:
    - "references"
    - "docs"

  doc_filename_patterns:
    - 'tutorial|guide|howto'
  dedupe_reference_aliases: false
  dedupe_duplicate_findings: false
  asset_prompt_injection_skip_in_docs: false

# ---------------------------------------------------------------------------
# Credentials – no test credentials are suppressed
# ---------------------------------------------------------------------------
credentials:
  known_test_values: []
  placeholder_markers: []

# ---------------------------------------------------------------------------
# System cleanup – strict mode trusts fewer rm targets
# ---------------------------------------------------------------------------
system_cleanup:
  safe_rm_targets:
    - "dist"
    - "build"
    - "tmp"
    - "temp"

# ---------------------------------------------------------------------------
# File classification – inherited from default (no relaxation)
# ---------------------------------------------------------------------------
file_classification:
  # In strict mode, still scan inert extensions (e.g. images) for embedded content
  skip_inert_extensions: false
  allow_script_shebang_text_extensions: false
  script_shebang_extensions:
    - ".py"
    - ".sh"
    - ".bash"
    - ".js"
    - ".ts"
    - ".rb"
    - ".pl"
    - ".php"

# ---------------------------------------------------------------------------
# File limits – tighter thresholds
# ---------------------------------------------------------------------------
file_limits:
  max_file_count: 50            # Half the default – stricter inventory
  max_file_size_bytes: 2097152  # 2 MB – flag large files earlier
  max_reference_depth: 3        # Less recursion
  max_name_length: 48           # Shorter names expected
  max_description_length: 512   # Shorter descriptions expected
  min_description_length: 30    # Require more descriptive text

# ---------------------------------------------------------------------------
# Analysis thresholds – more sensitive detection
# ---------------------------------------------------------------------------
analysis_thresholds:
  zerowidth_threshold_with_decode: 20   # Flag steganography earlier
  zerowidth_threshold_alone: 100        # Lower bar for standalone zero-width
  analyzability_low_risk: 95            # Require higher analyzability for LOW
  analyzability_medium_risk: 80         # Higher bar for MEDIUM
  min_dangerous_lines: 3                # Min confusable-char lines for HOMOGLYPH_ATTACK
  min_confidence_pct: 60                # Min confidence % for FILE_MAGIC_MISMATCH
  exception_handler_context_lines: 30   # Context lines around exception handlers
  short_match_max_chars: 2              # Max chars for "short match" in unicode steg
  cyrillic_cjk_min_chars: 5            # Min Cyrillic/CJK chars to suppress steg FP
  homoglyph_filter_math_context: false
  homoglyph_math_aliases:
    - "COMMON"
    - "GREEK"

# ---------------------------------------------------------------------------
# Sensitive files – expanded patterns
# ---------------------------------------------------------------------------
sensitive_files:
  patterns:
    - '/etc/(?:passwd|shadow|hosts|sudoers)'
    - '~?/\.(?:ssh|aws|gnupg|config|env|kube)'
    - '\.(?:env|pem|key|crt|p12|pfx|jks|keystore)'
    - '(?:credentials|secrets?|tokens?|password|private)'
    - '\$(?:HOME|USER|SSH_AUTH_SOCK|AWS_|KUBECONFIG)'

# ---------------------------------------------------------------------------
# Command safety – stricter: promote docker/kubectl/ssh to dangerous
# ---------------------------------------------------------------------------
command_safety:
  # Only override tiers you want to change; empty → use built-in defaults
  risky_commands:
    - "rm"
    - "dd"
    - "mkfs"
    - "mount"
    - "umount"
    - "fdisk"
    - "iptables"
    - "nft"
    - "ufw"
    - "systemctl"
    - "service"
    - "launchctl"
    - "crontab"
    - "at"
    - "nc"
    - "ncat"
    - "netcat"
    - "socat"
    - "telnet"
    - "nmap"

  dangerous_commands:
    - "curl"
    - "wget"
    - "eval"
    - "exec"
    - "source"
    - "bash"
    - "sh"
    - "zsh"
    - "dash"
    - "fish"
    - "csh"
    - "tcsh"
    - "ksh"
    - "sudo"
    - "su"
    - "doas"
    - "base64"
    - "openssl"
    - "gpg"
    # Promoted from risky in strict mode
    - "ssh"
    - "scp"
    - "rsync"
    - "sftp"
    - "docker"
    - "podman"
    - "kubectl"

  # Regex patterns that immediately classify a command as DANGEROUS.
  # Strict mode includes all default patterns plus additional ones.
  dangerous_arg_patterns:
    # Python/python3 inline code execution
    - '\bpython[23]?\s+.*-c\s'
    # Node inline JS execution
    - '\bnode\s+.*(?:-e|--eval)\s'
    # Ruby inline code execution
    - '\bruby\s+.*-e\s'
    # env spawning a shell
    - '\benv\s+.*(?:/bin/(?:ba)?sh|/bin/(?:z|da|fi)sh)'
    # find with -exec/-execdir
    - '\bfind\s+.*-exec(?:dir)?\s'
    # less/more/man with shell escape
    - '\b(?:less|more|man)\s+.*!\s*/bin/'
    # pip/pip3 install from untrusted index
    - '\bpip[3]?\s+install\s+(?:--index-url|--extra-index-url|-i)\s'
    # git clone/remote chained with shell operators
    - '\bgit\s+(?:clone|remote\s+add)\s+.*[;&|]'
    # Strict-only: pip install from any URL (supply-chain risk)
    - '\bpip[3]?\s+install\s+https?://'
    # Strict-only: npm run / npx arbitrary script execution
    - '\bnpm\s+(?:run|exec)\s'
    - '\bnpx\s+'

# ---------------------------------------------------------------------------
# Analyzers – all enabled in strict mode
# ---------------------------------------------------------------------------
analyzers:
  static: true
  bytecode: true
  pipeline: true

# ---------------------------------------------------------------------------
# LLM analysis – tighter context budgets for strict mode
# ---------------------------------------------------------------------------
llm_analysis:
  max_instruction_body_chars: 15000
  max_code_file_chars: 10000
  max_referenced_file_chars: 8000
  max_total_prompt_chars: 80000
  meta_budget_multiplier: 3.0

# ---------------------------------------------------------------------------
# Finding output – strict still dedupes duplicate issue records
# ---------------------------------------------------------------------------
finding_output:
  dedupe_exact_findings: true
  dedupe_same_issue_per_location: true
  same_issue_preferred_analyzers:
    - "meta_analyzer"
    - "llm_analyzer"
    - "meta"
    - "llm"
    - "behavioral"
    - "pipeline"
    - "static"
    - "yara"
    - "analyzability"
  same_issue_collapse_within_analyzer: true
  annotate_same_path_rule_cooccurrence: true
  attach_policy_fingerprint: true

# ---------------------------------------------------------------------------
# Severity overrides – promote some rules to higher severity
# ---------------------------------------------------------------------------
severity_overrides:
  - rule_id: BINARY_FILE_DETECTED
    severity: MEDIUM
    reason: "Strict mode treats unknown binaries as medium risk"
  - rule_id: HIDDEN_DATA_FILE
    severity: MEDIUM
    reason: "Strict mode flags all unknown hidden files at medium"
  - rule_id: PYCACHE_FILES_DETECTED
    severity: MEDIUM
    reason: "Strict mode flags bytecode distribution at medium"

disabled_rules: []
